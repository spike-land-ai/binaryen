# #2716: wasm2js: import { getTempRet0 } from 'env';

- **URL:** https://github.com/WebAssembly/binaryen/issues/2716
- **Author:** pdugre
- **Created:** 2020-03-30
- **Updated:** 2020-03-31
- **Labels:** help wanted, good first bug

## Description

Hi!

I am using the `wasm2js` tool on a WebAssembly module written in Rust using wasm-bindgen(no emscripten involved) to generate code that works on Internet Explorer. However, since I added a new library which internally makes use of i64, this import has been added to the `wasm2js` output:
```javascript
import { getTempRet0 } from 'env';
```

From what I understand, this method is used by emscriptem to handle i64 variables. However, my project is not using emscriptem, and I haven't found a way to remove or `pollyfill` this import, so I get the error saying that `env` is not found.

Is there something I can do to fix this?

EDIT: This seems like a bug, since setTempRet0 is never imported or used anywhere and no 64 bits variable is taken as a parameter or returned by any exported method. Also, in my case, manually defining `function getTempRet0() {return 0}` instead of the import makes the module works correctly.

## Comments (8)

### kripken (2020-03-30)

With i64 imports/exports that helper is generated, yes. It shouldn't be present if it's not used, if the optimizer runs. But maybe there's a bug, do you have a testcase?

This isn't an emscripten detail per se, btw, we have to do something for i64s. Otherwise they can't be used on the FFI boundary. So it's either avoid i64s in exports/imports, or use a helper like that.

(but yes, the name was taken from emscripten for lack of a better one...)

---

### pdugre (2020-03-30)

I've been trying to write a minimal test case but, unfortunately, I can't seem to find exactly what triggers it. The smallest test I found for now is by calling argon2::hash_raw() from the rust_argon2 crate in a `wasm-bindgen` path. I can create an example repo if you want. Note that doing this doesn't require any 64-bits variable across language, only locally in the Rust side.

Another thing is that these helpers doesn't exist if the repo was build without the binaryen toolchain. Is there any way we can import it if we only use the wasm2js tool?

---

### pdugre (2020-03-30)

I've put up a repo to reproduce the bug:
https://github.com/pdugre/binaryen-2716

These are the exports:
```javascript
export var memory = retasmFunc.memory;
export var test_binaryen = retasmFunc.test_binaryen;
export var __wbindgen_free = retasmFunc.__wbindgen_free;
```

These are the same export wether or not I am using the `argon2` library, but if I don't use it the `getTempRet0` is not imported. So if these methods should only be used on exports, there is indeed a bug preventing it to be optimized out.

---

### kripken (2020-03-30)

Any chance you can provide the wasm file, so I can just run the wasm2js command there?

---

### pdugre (2020-03-30)

Added on the repo with git lfs:
https://github.com/pdugre/binaryen-2716/blob/master/pkg/binaryen_2716_bg.wasm

---

### kripken (2020-03-30)

Thanks!

Looks like what's going on is that the code has `i64.div/rem` instructions. To implement those we include a bunch of support code to implement those operations (since JS can't do them itself). And those implementations include things like reinterprets of i64s, etc., and we need to use `getTempRet0` to get the upper bits of a function returning an i64.

So it makes sense it's used. However, we could probably see that it's only used internally, and replace the import with an internal implementation. I'm not sure offhand how easy that would be.

---

### pdugre (2020-03-31)

Good, at least we identified the cause! I'll see if I can do something about it.

---

### kripken (2020-03-31)

Great! Let me know if you have questions I can help with.

---


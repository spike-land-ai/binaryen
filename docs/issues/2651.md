# #2651: wasm-reduce: don't require test file and working file

- **URL:** https://github.com/WebAssembly/binaryen/issues/2651
- **Author:** fitzgen
- **Created:** 2020-02-07
- **Updated:** 2020-02-12

## Description

IIUC:

* `-t` provides the test file, which is what the predicate script is supposed to test
* `-w` provides the working file, which is where the final reduced result (and current-smallest during reduction) is placed

Users must provide both or `wasm-reduce` will not run.

I think there would be better user ergonomics if the predicate script was either

* passed the file to test as an argument, or
* the predicate script was always invoked with a temp dir as the current dir and that temp dir has the file to test inside it so that if the predicate script uses the test file via a relative path it always works (this is what `creduce` does)

Given one of those choices, then the user would only need to supply the input file and the predicate script. They would not also need to supply the test file and working file.

Additionally, both of those approaches would allow for multiple executions of the predicate script in parallel, opening up opportunities for speeding up the reduction process.

## Comments (9)

### tlively (2020-02-07)

Itâ€™s actually even more complicated than this. The user must supply a working file (only valid reductions are saved here), a test file (this is the file that the predicate command should run on) and the original file, which remains unchanged.

It would be simpler if the user only supplied the original file and the predicate command was also written to work on that original file. 

---

### kripken (2020-02-07)

@fitzgen I'm not sure what the difference is between

> -t provides the test file, which is what the predicate script is supposed to test

and in the proposal,

> passed the file to test as an argument

? Sorry, I must be missing your point here.

Doing what creduce does is an interesting option! That sounds reasonable to me. Perhaps the API could be

```
wasm-reduce input.wasm -o output.wasm ...
```

That is, replace `-w` with `-o` since now there is a single input.

@tlively If the user only provides the original, then the original would get trashed - which seems bad to me, as usually programs (e.g. `cp`) don't  trash their input. I agree it would make things simpler, but the cost seems high to me.

---

### kripken (2020-02-07)

I realize a downside with the temp dir approach is that sometimes testcases depend on more than one file. E.g. there might be `a.js` and `a.wasm` for a whole program. Then both would need to be copied to the temp dir, which means wasm-reduce would need to be aware of them, which complicates things. (Maybe this isn't an issue with c-reduce, but perhaps even there they have input files for the program - how are those handled?)

---

### tlively (2020-02-07)

I was imagining that the input file be first copied to a backup file. The original file could be restored from the backup file at the end of the reduction, but if there is a crash or interruption at least the backup file would still be there. The largest benefit of this approach is that the original failing command does not need to be modified at all.

---

### kripken (2020-02-07)

I see, thanks @tlively That sounds good to me. I guess we can print out "saving original to..." at the top, so people know what's going on. I can make a PR if we all agree this is the way to go.

---

### fitzgen (2020-02-07)

> @fitzgen I'm not sure what the difference is between
> 
> > -t provides the test file, which is what the predicate script is supposed to test
> 
> and in the proposal,
> 
> > passed the file to test as an argument
> 
> ? Sorry, I must be missing your point here.

In the current setup, the predicate script takes zero command line arguments and implicitly acts upon the file passed via `-t` by just knowing that it should. The `-t` is agreed upon before hand and hard coded in the predicate script.

Instead, the predicate script could take one command line argument: the path to the file to test. Now users don't need to explicitly pass `-t <file>` and `wasm-reduce` can generate its own temp files instead.

---

### kripken (2020-02-07)

I see, thanks @fitzgen! Yeah, that sounds reasonable too I think.

---

### tlively (2020-02-07)

I like having my command be a literal shell line including pipes and redirects rather than a call to a script, so expecting the command to take an argument would break my workflow. I can always change my workflow for the greater good, of course, but I would prefer we expect the command to be self-contained.

---

### kripken (2020-02-12)

Thinking on this for a while, I lean towards the temp directory approach. Any further thoughts?

---


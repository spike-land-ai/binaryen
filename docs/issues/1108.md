# #1108: wasm-opt: tables cannot be declared after functions

- **URL:** https://github.com/WebAssembly/binaryen/issues/1108
- **Author:** jayphelps
- **Created:** 2017-07-21
- **Updated:** 2017-09-19

## Description

wasm-opt appears to expect tables in textual wast to be declared before any function bodies, but some utilities such as wabt's wasm2wast always places it after, near the bottom of the file.

> [parse exception: no table]Fatal: error in parsing input

https://github.com/WebAssembly/binaryen/blob/b2c17a105e9fbe86c059793032ee0be676245a8a/src/wasm/wasm-s-parser.cpp#L1356

If I move the table text above the functions, the issue resolves.

```diff
 (module
   (type $t0 (func))
+  (table 1 anyfunc)
   (func $f0 (type $t0))
   (func $f1 (type $t0)
     (call_indirect $t0
       (i32.const 0)
     )
   )
-  (table 1 anyfunc)
   (elem (i32.const 0) $f0)
 )
```

I recall seeing a rough spec for the textual format but can't seem to find it right now to see whether binaryen or wabt is at fault or if this is just undefined behavior. I only see the super high level [Text Format](http://webassembly.org/docs/text-format/) page.

## Comments (5)

### binji (2017-07-21)

The spec for the text format is here: http://webassembly.github.io/spec/text/index.html.

In general, the text format allows everything to be specified in any order. The only constraint is that imports must be specified before any non-imports.

---

### jayphelps (2017-07-21)

@binji wow I hadn't even seen that site before üò± looks like the draft spec you all have been working on. Thanks much!




---

### binji (2017-07-21)

Yep :-)

@rossberg-chromium discussed it at the most recent WebAssembly CG meeting earlier this week. It is basically feature-complete, minus a few minor appendices.

---

### jayphelps (2017-07-21)

@binji I don't have a ton of cycles, but if the fix is rather quick I'm happy to do it--though it seems like the correct way would be to refactor things to not parse function bodies until after parsing the rest of the file.

Cc/ @dschuff since I believe he authored that particular check.

Edit: I also just remembered that I'm no longer apart of the CG because my involvement in wasm is not related to my employer and I cannot join without it representing them (by W3C rules). I think that prevents me from contributing code entirely ‚òπÔ∏è 

---

### binji (2017-07-21)

@jayphelps I see. I don't really know much about binaryen, but it looks like it could just be added as another pre-parse, e.g. `preParseTables`.

---


# #5118: wasm-opt: Optimize out store of load with traps-never-happen

- **URL:** https://github.com/WebAssembly/binaryen/issues/5118
- **Author:** Anonymity20202
- **Created:** 2022-10-06
- **Updated:** 2025-01-20

## Description

Such WebAssembly code snippet will not be optimized by `wasm-opt`
```wasm
    (local $var i32)
    ...
    local.tee $var
    local.get $var
    i32.load
    i32.store
```
However, this equals 
```c
*var = *var
```
which is safe to remove.

## Comments (4)

### MaxGraey (2022-10-06)

> which is safe to remove.

That's not safe in WebAssembly due to load / store has side effects (it may trap OOB). And we already [discussed about this](https://github.com/WebAssembly/binaryen/issues/4948#issuecomment-1221308762)

---

### Anonymity20202 (2022-10-06)

It may trap OOB only when the value of `$var` is undeterministic or the pointed memory is undefined, when this is not the case, I do not see why it is not safe to remove. 
For example, 
```wasm
    (local $var i32)
    ...
    i32.const 100
    local.tee $var
    i32.const 0
    i32.store
    local.tee $var
    local.get $var
    i32.load
    i32.store
```

---

### Anonymity20202 (2022-10-06)

Or similarly,
```wasm
    i32.const 1776
    i32.const 0
    i32.store
    i32.const 1776
    i32.const 1
    i32.store
```

---

### kripken (2022-10-06)

I suppose we could optimize this when `trapsNeverHappens` is set. Then we can assume that doesn't trap, and the write is redundant.

(edit: ah, I see that was already mentioned in the old thread, sorry for the noise.)

---


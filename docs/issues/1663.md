# #1663: Slow to disassemble some crafted wasm files

- **URL:** https://github.com/WebAssembly/binaryen/issues/1663
- **Author:** hongxuchen
- **Created:** 2018-09-02
- **Updated:** 2018-09-03

## Description

wasm-dis may sometimes spend too much time to disassemble certain crafted wasm files.
[wasm-dis-slow.zip](https://github.com/WebAssembly/binaryen/files/2343423/wasm-dis-slow.zip)

It turns out that inside `WasmBinaryBuilder::readFunctions()`, at https://github.com/WebAssembly/binaryen/blob/master/src/wasm/wasm-binary.cpp#L1073-L1080, the value `num` may get extremely large (I haven't figured out why yet), and subsequent operations require too much time to finish.

## Comments (3)

### kripken (2018-09-02)

Thanks! Fixes and details in #1664, turns out there were two issues here (we need to handle ridiculously-large numbers of locals, and we also emitted locals much slower than we needed to).

I suspect I didn't see this in my own fuzzing since I've focused on crashes, and this happened to hang and not crash because of that slowness.

---

### binji (2018-09-02)

Both of these files also have other issues too:

`h01.wasm` has a code section that is too short (9 bytes).

```
$ wasm-objdump h01.wasm -s
h01.wasm:	file format wasm 0x1
0000018: error: invalid local declaration count 127, only 6 bytes left in section
0000020: error: invalid section code: 126; max is 11

Contents of section Type:
000000a: 0160 0001 7f                             .`...

Contents of section Function:
0000011: 0100                                     ..

Contents of section Code:
0000015: 0107 7fff ffff 7f7f 7e                   ........~
```

function 2 in `h02.wasm` has a local declaration of type `0x40`:
```
$ wasm-objdump h02.wasm -d
0000129: error: expected valid local type
000029a: error: invalid section size: extends past end

[---snip---]

00011d func[2]:
 00011f: 02 7f                      | local[0..1] type=i32
 000121: ff ff ff ff 03 7c          | local[2..1073741824] type=f64
```

---

### hongxuchen (2018-09-03)

Seems that the section size issue may also raise a `bad_alloc` exception.
[wasm-dis.zip](https://github.com/WebAssembly/binaryen/files/2344086/wasm-dis.zip).

```
./wasm-objdump -d wasm-dis/alloc_01.wasm
alloc_01.wasm:  file format wasm 0x1
0000052: error: invalid section code: 507; max is 11
Code Disassembly:

$ ./wasm-objdump -d wasm-dis/alloc_02.wasm
alloc_02.wasm:  file format wasm 0x1
000002a: error: invalid section code: 16383; max is 11
Code Disassembly:

```




---


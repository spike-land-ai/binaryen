# #7672: SimplifyLocals causes ineffective code

- **URL:** https://github.com/WebAssembly/binaryen/issues/7672
- **Author:** xuruiyang2002
- **Created:** 2025-06-21
- **Updated:** 2025-06-21

## Description

Given the following code:

``` webassembly
(module
  (type (;0;) (func))
  (import "External" "external_function" (func $external_function (type 0)))
  (func $_start (type 0)
    i32.const 9576
    i32.load
    i32.load
    i32.load
    drop
    i32.const 9576
    i32.load
    i32.load
    i32.load
    i32.const 9576
    i32.load
    i32.load
    i32.load
    i32.gt_s
    if (result i32)  ;; label = @1
      call $external_function
      i32.const 1
    else
      i32.const 0
    end
    drop
    unreachable)
  (memory $0 258 258)
  (export "_start" (func $_start)))
```

For wasm-opt (c91c0520a61), `-O3 -sp=simplify-locals` can eliminate the unreachable code, while `-O3` cannot:

``` webassembly
 (func $_start
  (local $0 i32)
  (if
   (i32.gt_s
    (local.tee $0
     (i32.load
      (i32.load
       (i32.load
        (i32.const 9576)
       )
      )
     )
    )
    (local.get $0)
   )
   (then
    (call $external_function)
   )
  )
  (unreachable)
 )
```

After investigating, it is the Wasm-specific optimization `simplify-locals` causes the counter-intuitive code. Below is the change made by `simplify-locals`:

![Image](https://github.com/user-attachments/assets/c0c97791-3af6-45e1-a485-200a002b3de2)

As you can see, the currently wasm-opt cannot optimize the `if` condition on the right---it can only do that on the left, which I think it is missed optimization (It is not the  `simplify-locals` fault...).

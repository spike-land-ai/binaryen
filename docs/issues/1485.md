# #1485: Type-check invalid unreachable code

- **URL:** https://github.com/WebAssembly/binaryen/issues/1485
- **Author:** pepyakin
- **Created:** 2018-03-20
- **Updated:** 2018-03-20

## Description

```WebAssembly
(module
  (memory 1)
  (func (param i64) (result i64)
    unreachable
    br_if 0
    i64.load
  )
)
```

however, the spec interpreter and wabt doesn't, reporting: 

```
0000000: error: type mismatch in i64.load, expected [i32] but got [i64]
```

I guess this is related to the way how binaryen treats unreachable code...

## Comments (8)

### pepyakin (2018-03-20)

cc https://github.com/WebAssembly/spec/pull/756

---

### kripken (2018-03-20)

Using `wasm-dis` implies you converted that text to binary first - how did you do it? Binaryen's wasm-as fails on it (it doesn't support the stacky format without parens, it just supports s-expressions), reporting
```
[parse exception: expected list (at 4:4)]Fatal: error in parsing input
```
and wabt's wat2wasm fails on the error you mention.

---

### pepyakin (2018-03-20)

I used `wat2wasm --no-check` )

---

### kripken (2018-03-20)

full wabt error:
```
a.wast:6:5: error: type mismatch in i64.load, expected [i32] but got [i64]
    i64.load
    ^^^^^^^^
```

---

### kripken (2018-03-20)

I see, thanks. Yeah, this is due to binaryen's handling of unreachable code - it just drops unreachable sections instead of trying to parse them, so here it just emits
```
 (func $0 (; 0 ;) (type $0) (param $var$0 i64) (result i64)
  (block $label$0 (result i64)
   (unreachable)
  )
 )
```
(everything after the unreachable is lost).

I'm not opposed to adding support for error handling in those sections, but it's not a major goal for binaryen to have full support for proper parsing of invalid wasms, in my opinion at least (I care more about optimizing valid ones well).

---

### pepyakin (2018-03-20)

Yeah, I understand and expected answer like that. But, I'm still wondering, isn't this issue affect `assert_invalid` cases in testsuite? Is binaryen just skips these?

---

### kripken (2018-03-20)

We run those asserts in general, but we skip the stacky parts of the spec test suite, that's probably where that test is?

---

### kripken (2018-03-20)

Renamed the issue for the more general issue of type-checking unreachable code.

---


# #1215: Handling of exported _GLOBAL__sub_I_* functions

- **URL:** https://github.com/WebAssembly/binaryen/issues/1215
- **Author:** Markyparky56
- **Created:** 2017-10-07
- **Updated:** 2017-10-10

## Description

First off, I'm not sure if binaryen is the right place to raise this as this may go further up to llc or llvm/clang, or if it's an issue further down with wabt, but I'm trying here first as this issue is specific to WebAssembly.
Additionally this is not an Emscripten issue, I'm manually passing my code through clang->llvm-link (if there are multiple code files)->llc->s2wasm->wat2wasm->wasm-opt to get my binaries.

I noticed in the wat file produced by s2wasm that it was exporting a function called `_GLOBAL__sub_I_main.withinternalfloatarr.cpp`, and can trace it back to the .s file produced by llc (which means it's also part of the .bc file produced by clang/clang++) which places it in a section called `__startup` 

```
    .section	.text.__startup,"ax",@progbits
	.type	_GLOBAL__sub_I_main.withinternalfloatarr.cpp,@function
_GLOBAL__sub_I_main.withinternalfloatarr.cpp:
...
```

However since this function contains full-stops because of the filename in it when it finally reached the compiled module's exports it was both there (`console.log(module.exports)`) and not there (trying to actually access it at `module.exports._GLOBAL__sub_I_main.withinternalfloatarr.cpp`).

These `_GLOBAL__sub_I_` functions from what I can tell do all the setting up in the background that you take for granted in a normal C/C++ application, however since this function doesn't seem to be getting called when the module is instanced or even callable manually is a bit problematic.

## Comments (6)

### kripken (2017-10-08)

These are global constructor functions, called during startup, yeah. Sounds like the name contains an illegal character, and either the wasm backend or s2wasm doesn't handle that properly? The wasm backend should emit it in a way that is legal in wasm, so probably that's the culprit. Can you provide a testcase (source or bitcode file and full steps to reproduce)?

---

### Markyparky56 (2017-10-08)

Attached a zip with a test case producing an example of a _GLOBAL___sub_I exported function which is uncallable due to the presence of a period in its name. 
Contents includes the code file (main.cpp), the bitcode from clang (main.bc), the s-expressions from llc (main.s), the webassembly text format from s2wasm (main.wat) and the compiled wasm from wat2wasm (main.wasm). Also included is main.html which loads the module to demonstrate that it doesn't initialise the object which otherwise would be initialised by the start up function, and that the exported global function is visible under the instance's exports (check the developer console for all output).

[wasmtestcase.zip](https://github.com/WebAssembly/binaryen/files/1366970/wasmtestcase.zip)

Compiled using this process on windows:
```
> clang -c -v --target=wasm32 -std=c++14 -emit-llvm -Oz main.cpp
> llc -O2 main.bc -o main.s
> s2wasm main.s > main.wat
> wat2wasm main.wat -o main.wasm
```

I understand there is another wasm32 target available via `--target=wasm32-unknown-unknown-wasm`, but it uses lld which I haven't got installed yet, that's the next item on my list to investigate though. 

---

### Markyparky56 (2017-10-09)

Tried compiling the same code file with the command
```
> clang --target=wasm32-unknown-unknown-wasm -std=c++14 -Oz -c -v main.cpp -o main.wasm
```
But it returns a fatal error from the backend:
```
fatal error: error in backend: Wasm COMDATs only support SelectionKind::Any, '_ZN16PermutationTable7SetSeedEi' cannot
      be lowered.
clang.exe: error: clang frontend command failed with exit code 70 (use -v to see invocation)
```
Waiting on llvm.org/bugs getting back with an account so I can submit the bug report it gives me.

Tried --target=wasm64-unknown-unknown-wasm since that last error about lowering is is probably linked to the fact that my code uses a lot of `unsigned long long`s. Get a slightly less legible error:
_note: Checked the design docks to confirm, the MVP only supports wasm32, making the likelihood of this working slim, even if the targets are available_
```
fatal error: error in backend: Cannot select: 0x70df798: i32,ch = load<LD1[%3](tbaa=<0x2b15b8>), zext from i8>
      0x70b4760, 0x70df528, undef:i64
  0x70df528: i64 = add 0x70df3f0, 0x70df4c0
    0x70df3f0: i64 = sign_extend 0x70df388
      0x70df388: i32 = WebAssemblyISD::ARGUMENT TargetConstant:i32<0>
        0x70df320: i32 = TargetConstant<0>
    0x70df4c0: i64 = WebAssemblyISD::Wrapper TargetGlobalAddress:i64<%class.PermutationTable* @permTable> 0
      0x70df730: i64 = TargetGlobalAddress<%class.PermutationTable* @permTable> 0
  0x70df590: i64 = undef
In function: GetPermAt
clang++.exe: error: clang frontend command failed with exit code 70 (use -v to see invocation)
```
The WebAssembly backend is still experimental, which this may be highlighting.

Interestingly, if I remove the period from the _GLOBAL_... function in the wat code output by s2wasm and compile it via wat2wasm, manually calling it after the module is instanced throws a `RuntimeError: memory access out of bounds`. Since the global function just invokes the SetSeed function of the class, if you export a C call to that function calling that also throws the same error. Double checked that the code was safe but adding a main function which mirrors the html file and compiled that to a simple exe and it works as expected. 

---

### kripken (2017-10-10)

Thanks. Yeah, this looks like a bug in the wasm backend, so when you can please open a bug there. I verified this works ok with emcc without the wasm backend.

---

### jgravelle-google (2017-10-10)

Trying with the example you provided:
Trying to access the field with a period in its name in JS like so: `main.exports._GLOBAL__sub_I_main.cpp`, does not work.
Accessing it via its string name: `main.exports['_GLOBAL__sub_I_main.cpp']`, has no issues, aside from the memory access out of bounds runtime error that you saw from manually editing the wat. So, not a bug at all as far as I can tell.
The memory out of bounds is because that function is writing locals to the stack in linear memory, which has no corresponding data section to initialize it, so it starts out zeroed, gets subtracted from in `_ZN16PermutationTable7SetSeedEi`, underflows to `UINT_MAX`, then is out of bounds when written to in the call to `_ZN3rng7setSeedEy`. So, also not a bug.

The wasm32-unknown-unknown-wasm target is very much under development. The wasm64 target is defined, but pretty much entirely unimplemented.

---

### Markyparky56 (2017-10-10)

Bug for the wasm backend [here](https://bugs.llvm.org/show_bug.cgi?id=34901), they are aware of the lacking COMDAT support.

Never even thought to try accessing the export via a string, spent too much time with C++ maybe. 

Compiling the test case with em++, then converting the wasm back to wat with wasm2wat shows that at some point during compilation the `_GLOBAL__sub_I_main.cpp` was converted to `_GLOBAL__sub_I_main_cpp`

Solved the issue of there being no stack to play with by specifying `-s 524288` (maybe a little much for this but a safe amount) when calling s2wasm i.e. `s2wasm -s 524288 main.s > main.wat`, and it works like a charm! 

---


# #3759: Flatten pass can make invalid modules on tuple types

- **URL:** https://github.com/WebAssembly/binaryen/issues/3759
- **Author:** martianboy
- **Created:** 2021-03-30
- **Updated:** 2021-03-30

## Description

This came up while fuzzing, and I traced it using `git bisect` to PR #3710 where non-nullable locals are handled by `handleNonNullableLocals`. It doesn't seem to handle tuple types that contain a non-nullable ref, resulting in a validation error after Flatten pass.

    seed: 17382324165229480416

Full validation result:

```[PassRunner]   (validating)
[wasm-validator error in function 3] unexpected false: vars must be defaultable, on 
(v128 (ref (func (param f32))) v128 i64)
[wasm-validator error in function 3] unexpected false: vars must be defaultable, on 
(v128 (ref (func (param f32))) v128 i64)
[wasm-validator error in function 3] unexpected false: vars must be defaultable, on 
(v128 (ref (func (param f32))) v128 i64)
[wasm-validator error in function 3] unexpected false: vars must be defaultable, on 
(v128 (ref (func (param f32))) v128 i64)
Fatal: Last pass (flatten) broke validation. Run with BINARYEN_PASS_DEBUG=2 in the env to see the earlier state, or 3 to dump byn-* files for each pass
```

Also `wasm-reducer` crashes with the following message when reducing the original file:

    Missing type: (func (param externref f32) (result f32))
    wasm-reduce: ../src/wasm/wasm-binary.cpp:529: uint32_t wasm::WasmBinaryWriter::getTypeIndex(wasm::HeapType) const: Assertion `0' failed.


## Comments (1)

### kripken (2021-03-30)

Thanks, https://github.com/WebAssembly/binaryen/pull/3760 will work around this in the fuzzer for now. Let's keep this open for a proper solution.

---


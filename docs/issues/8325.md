# #8325: wasm-opt --flatten fails with exceptions or GC

- **URL:** https://github.com/WebAssembly/binaryen/issues/8325
- **Author:** juntyr
- **Created:** 2026-02-13
- **Updated:** 2026-02-13

## Description

When running wasm-opt on the following WASM file [demo.wasm.zip](https://github.com/user-attachments/files/25282203/demo.wasm.zip), using `-O4` or `--flatten`, the following exception is raised (tested in v124 and v125):

```
unexpected expr type
UNREACHABLE executed at /nix/var/nix/builds/nix-29457-2897100894/source/src/passes/Flatten.cpp:231
```

My complete command is

```bash
"wasm-opt" \
    "--enable-sign-ext" "--disable-threads" "--enable-mutable-globals" \
    "--enable-nontrapping-float-to-int" "--enable-simd" "--enable-bulk-memory" \
    "--enable-exception-handling" "--disable-tail-call" "--enable-reference-types" \
    "--enable-multivalue" "--disable-gc" "--disable-memory64" \
    "--disable-relaxed-simd" "--disable-extended-const" "--disable-strings" \
    "--disable-multimemory" "--strip-debug" "-O0" "--flatten" \
    "-o" "demo.opt.wasm" "demo.wasm"
```

## Comments (3)

### kripken (2026-02-13)

This is a current limitation. GC is also not fully supported.

We have some ideas for how to extend Flatten to those features (which bring new control flow structures, making the "flat" form less simple), but no specific plans atm.

Is this important for you, or did you just notice `-O4` was broken?

---

### juntyr (2026-02-13)

I was -O4 previously and have for now switched to -O3 (so fixing this is not urgent but I wanted to raise it)

---

### kripken (2026-02-13)

Sounds good, thanks. `-O3` does the same, just without Flatten, so that should be good enough. But maybe someday we'll improve Flatten too. I'll rename this issue for that.

---


# #4256: Add option to force table elements to be considered immutable

- **URL:** https://github.com/WebAssembly/binaryen/issues/4256
- **Author:** sbc100
- **Created:** 2021-10-18
- **Updated:** 2021-10-19

## Description

Binaryen has some optization that is unlocked when the table is immutable:

https://github.com/WebAssembly/binaryen/blob/0bec0a4bbaf4859bb4c7a2f1c4ecda60ccab72f2/src/passes/Directize.cpp#L174-L178

With emscripten however, the table is always either imported or exported so this optimization is never enabled in practice.

However, emscripten usage of the table from JS never actually mutates existing table elements.  It will read from the table and add new elements but it will never mutate of remove table elements generated by C/C++ (wsam-ld). 

Perhaps we could have an options such as `--immutable-table-elems` which would force binaryen to consider static table elements to be immutable?   We should run some benchmarks to see if this is worth while.

## Comments (6)

### MaxGraey (2021-10-18)

I guess this feature will be perfect also for memory. We discussed about this here: https://github.com/WebAssembly/binaryen/issues/3263

---

### sbc100 (2021-10-18)

Yes, good point!  Sorry I forget about that existing issue.

---

### kripken (2021-10-18)

I did a run of the emscripten benchmark suite. It does manage to devirtualize some calls in musl's printing code (`out(), pop_arg()`) but those do not matter for speed. This definitely has potential, but at least on those benchmarks it doesn't look especially promising.

---

### sbc100 (2021-10-18)

> I did a run of the emscripten benchmark suite. It does manage to devirtualize some calls in musl's printing code (`out(), pop_arg()`) but those do not matter for speed. This definitely has potential, but at least on those benchmarks it doesn't look especially promising.

In those cases do you know if those functions also then be removed from the table completely?  

---

### kripken (2021-10-18)

I could check, but even if we assume the table is immutable that doesn't mean we can alter it, as we don't know what indexes the outside will call with...

---

### sbc100 (2021-10-19)

The only way the outside could get a table index would be if it was passed out by some code on the inside, but I suppose the problem is we don't know all the places where a table slot is referenced since binaryen doesn't get relocation information.   If it did have relocation information it could know exactly when a given table slot was no longer needed... 

---


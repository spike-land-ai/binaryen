# #5991: wasm2js/I64ToI32Lowering fails on 64-bit atomic stores (I think) test_atomic_wait64_notify

- **URL:** https://github.com/WebAssembly/binaryen/issues/5991
- **Author:** sbc100
- **Created:** 2023-10-03
- **Updated:** 2024-10-28

## Description

I'm currently landing a new test `test_atomic_wait64_notify` which is failing under wasm2js:

```
test_atomic_wait64_notify (test_core.wasm2js1.test_atomic_wait64_notify) ... Clearing existing test directory
wasm2js: /usr/local/google/home/sbc/dev/wasm/binaryen/src/passes/I64ToI32Lowering.cpp:423: void wasm::I64ToI32Lowering::visitStore(wasm::Store *): Assertion `!curr->isAtomic && "atomic store not implemented"' failed.
emcc: error: '/usr/local/google/home/sbc/dev/wasm/binaryen-out/bin/wasm2js --emscripten -O test_atomic_wait64_notify.wasm --mvp-features --enable-threads --enable-bulk-memory --enable-mutable-globals --enable-sign-ext' failed (received SIGABRT (-6))
None
None
FAIL
```



## Comments (8)

### sbc100 (2023-10-03)

See https://github.com/emscripten-core/emscripten/pull/20381

---

### maceip (2024-10-17)

@sbc100 cc @juj how did you get around this?

with:
```
wasm2js version 119 (version_119-78-gfd86eadb5)
clang version 20.0.0git (https://github.com/llvm/llvm-project 282ab2f1895450707c9f8fc6a46634620165d1c9)
```
& a wasm generated with nightly
```
RUSTFLAGS='-C target-feature=+atomics,+bulk-memory,+mutable-globals'
```

+ wasm-opt

```
[package.metadata.wasm-pack.profile.release]
opt-level = "z"
wasm-opt = true
```

& [wasm-bindgen-rayon](https://github.com/GoogleChromeLabs/wasm-bindgen-rayon)


_i get the same error_, and ```--enable-threads``` or hungry-hippoing lowering options doesnt seem to impact it (post-compile or via wasm2js)


simple repro:

```
 git clone https://github.com/RReverser/wasm-bindgen-rayon & cd wasm-bindgen-rayon/demo
npm i && npm run build:wasm-mt
~/binaryen/bin/wasm2js pkg-parallel/wasm_bindgen_rayon_demo_bg.wasm -o wbr.js
wasm2js: /home/mac/binaryen/src/passes/I64ToI32Lowering.cpp:382: void wasm::I64ToI32Lowering::visitLoad(Load *): Assertion `!curr->isAtomic && "64-bit atomic load not implemented"' failed.

---

### juj (2024-10-18)

I think wasm2js never gained support for 64bit atomics.

I recall that in some development tests that I did with wasm2js, I hackily disabled 64bit atomics, and just lowered them to regular 64bit loads and stores. (this is because I wanted to just debug something else, and didn't care about the actual 64bit atomics code site)

---

### maceip (2024-10-18)

thx for the context


---

### juj (2024-10-18)

@kripken I wonder if wasm2js lack of 64bit atomics would make sense to be demoted to a warning? That would let people compile stuff, and maybe such atomicity might not be in the critical path (e.g. for debugging purposes)

---

### kripken (2024-10-18)

@juj Hmm, a warning seems risky, as we would make those operations un-atomic, which could lead to very hard to debug issues with race conditions in apps. And I worry a warning at compile time could be ignored long before such a problem is noticed in production.

If this is important to do then I would prefer to properly implement 64-bit atomics in wasm2js. That shouldn't be too hard, though it would be slower than wasm (I think we'd need a full lock, unless JS Atomics support BigInt64Array..?)

---

### maceip (2024-10-27)

@kripken for bg the react native js engine (hermes) doest yet support wasm, but does support asm.js so I was doing something like 
```
wasm2js zk.wasm > zk.js
shermes zk.js -o zk && ./zk
```

even if wasm2js was slower for 64bit atomics id guess hermes will optimize it? 

---

### sbc100 (2024-10-28)

@maceip does hermes support multi-threading (e.g via pthreads as web workers?)   If not then you be able to compile away all atomics to normal memory accesses.

---


# #4166: Improve selectify

- **URL:** https://github.com/WebAssembly/binaryen/issues/4166
- **Author:** MaxGraey
- **Created:** 2021-09-18
- **Updated:** 2021-10-05

## Description

I think I already mentioned a similar problem, but it was a long time ago.

If we have an "if" branch without a false arm, you selectify stops working:
```ts
function selectify_early_return(x: i32): i32 {
  if (x) return x;
  return 1;
}
```

Just add this test into `lit/remove-unused-brs.wast` as:
```wat
  ;; CHECK:      (func $selectify-early-return (param $x i32) (result i32)
  ;; CHECK-NEXT:  (if
  ;; CHECK-NEXT:   (local.get $x)
  ;; CHECK-NEXT:   (return
  ;; CHECK-NEXT:    (local.get $x)
  ;; CHECK-NEXT:   )
  ;; CHECK-NEXT:  )
  ;; CHECK-NEXT:  (i32.const 1)
  ;; CHECK-NEXT: )
  (func $selectify-early-return (param $x i32) (result i32)
    (if
      (local.get $x)
      (return (local.get $x))
    )
    (i32.const 1)
  )
```
But obversely we expect something like this insted:
```wat
(func $selectify-early-return (param $x i32) (result i32)
  (select
    (local.get $0)
    (i32.const 1)
    (local.get $0)
  )
)
```
The main problem here: https://github.com/WebAssembly/binaryen/blob/main/src/passes/RemoveUnusedBrs.cpp#L1077
`selectify` just skip optimisation if `ifFalse` is not exists. So it is necessary to canonicalze such cases before applying selectify. Any idea how best to do this?

## Comments (2)

### kripken (2021-09-20)

Good find. I think `RemoveUnusedBrs` will optimize things like this, but with breaks. So it would need to be extended to handle returns as well.

To test that theory, I'd write this as a break to a toplevel block and see if it optimizes that.

---

### MaxGraey (2021-10-05)

Unfortunately this also can't optimized:
```wat
  ;; CHECK:      (func $selectify-early-return (param $x i32) (result i32)
  ;; CHECK-NEXT:  (block $x (result i32)
  ;; CHECK-NEXT:   (br_if $x
  ;; CHECK-NEXT:    (local.get $x)
  ;; CHECK-NEXT:    (return
  ;; CHECK-NEXT:     (local.get $x)
  ;; CHECK-NEXT:    )
  ;; CHECK-NEXT:   )
  ;; CHECK-NEXT:   (i32.const 1)
  ;; CHECK-NEXT:  )
  ;; CHECK-NEXT: )
  (func $selectify-early-return (param $x i32) (result i32)
    (block $x (result i32)
      (br_if $x
        (local.get $x)
        (return (local.get $x))
      )
      (i32.const 1)
    )
  )
```

---

